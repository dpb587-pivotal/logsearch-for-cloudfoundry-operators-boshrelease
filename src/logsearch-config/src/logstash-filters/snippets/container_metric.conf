if [syslog_program] == "doppler" {
  grok {
    match => { "@message" => "\"event_type\"\:\"ContainerMetric\"" }
    tag_on_failure => ["fail/containermetric/grok"]
    add_tag => ["ContainerMetric"]
    overwrite => ["@message"]
  }

  if "ContainerMetric" in [tags] {
    json {
      source => "@message"
      target => "ContainerMetric"
      remove_field => ["@message"]
    }

    mutate {
      add_field => { "@type" => "ContainerMetric" }
      rename => { "[ContainerMetric][level]" => "@level" }
    }

    date {
      match => [ "[ContainerMetric][time]", "ISO8601"]
      target => "@timestamp"
    }

    mutate {
      uppercase => [ "@level" ]
    }

    mutate {
      rename => { "syslog_program" => "[@source][program]" }
      rename => { "syslog_hostname" => "[@source][host]" }
      rename => { "[ContainerMetric][cf_app_id]" => "[cf][app_id]" }
      rename => { "[ContainerMetric][cf_app_name]" => "[cf][app_name]" }
      rename => { "[ContainerMetric][cf_org_id]" => "[cf][org_id]" }
      rename => { "[ContainerMetric][cf_org_name]" => "[cf][org_name]" }
      rename => { "[ContainerMetric][cf_space_id]" => "[cf][space_id]" }
      rename => { "[ContainerMetric][cf_space_name]" => "[cf][space_name]" }
    }

    mutate {
      remove_field => [
        "[ContainerMetric][event_type]",
        "[ContainerMetric][msg]",
        "[ContainerMetric][origin]",
        "[ContainerMetric][time]"
      ]
    }
  } else {
    mutate {
      remove_tag => [ "fail/containermetric/grok" ]
    }
  }
}
